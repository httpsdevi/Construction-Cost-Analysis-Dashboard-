<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Cost Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .kpi-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
        }

        .kpi-trend {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .positive { color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .negative { color: #27ae60; background: rgba(39, 174, 96, 0.1); }
        .neutral { color: #f39c12; background: rgba(243, 156, 18, 0.1); }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 400px;
            position: relative;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .table-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-cell {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .status-overbudget { background: #ffebee; color: #c62828; }
        .status-ontrack { background: #e8f5e8; color: #2e7d32; }
        .status-warning { background: #fff3e0; color: #ef6c00; }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 25px;
            color: white;
        }

        select, input {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .insights-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .insight-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid;
            background: #f8f9fa;
        }

        .insight-critical { border-left-color: #e74c3c; }
        .insight-warning { border-left-color: #f39c12; }
        .insight-success { border-left-color: #27ae60; }

        @media (max-width: 768px) {
            .dashboard { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .charts-section { grid-template-columns: 1fr; }
            .kpi-section { grid-template-columns: 1fr; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .canvas-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üèóÔ∏è Construction Cost Analysis Dashboard</h1>
            <p>Real-time insights into project performance, cost variances, and resource utilization</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Project Filter:</label>
                <select id="projectFilter">
                    <option value="all">All Projects</option>
                </select>
            </div>
            <div class="control-group">
                <label>Vendor Filter:</label>
                <select id="vendorFilter">
                    <option value="all">All Vendors</option>
                </select>
            </div>
            <div class="control-group">
                <label>Date Range:</label>
                <input type="month" id="dateFilter" />
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-section">
            <div class="kpi-card">
                <div class="kpi-value" id="totalCostVariance">$0</div>
                <div class="kpi-label">Total Cost Variance</div>
                <div class="kpi-trend" id="costVarianceTrend">Loading...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="avgScheduleDelay">0 days</div>
                <div class="kpi-label">Average Schedule Delay</div>
                <div class="kpi-trend" id="scheduleDelayTrend">Loading...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="resourceUtilization">0%</div>
                <div class="kpi-label">Resource Utilization</div>
                <div class="kpi-trend" id="utilizationTrend">Loading...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="projectsAtRisk">0</div>
                <div class="kpi-label">Projects at Risk</div>
                <div class="kpi-trend" id="riskTrend">Loading...</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-title">Vendor Cost Performance Analysis</div>
                <div class="canvas-container">
                    <canvas id="vendorChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Planned vs Actual Cost Trend</div>
                <div class="canvas-container">
                    <canvas id="costTrendChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Resource Utilization by Project</div>
                <div class="canvas-container">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Schedule Performance Distribution</div>
                <div class="canvas-container">
                    <canvas id="scheduleChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Project Performance Table -->
        <div class="table-section">
            <h3>üìä Project Performance Summary</h3>
            <table class="data-table" id="projectTable">
                <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>Project Name</th>
                        <th>Vendor</th>
                        <th>Planned Cost</th>
                        <th>Actual Cost</th>
                        <th>Cost Variance</th>
                        <th>Schedule Status</th>
                        <th>Resource Util.</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody id="projectTableBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- AI-Powered Insights -->
        <div class="insights-panel">
            <h3>ü§ñ AI-Powered Insights & Recommendations</h3>
            <div id="insightsContainer">
                <!-- Insights will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Simulated Data Generation
        class DataGenerator {
            constructor() {
                this.vendors = ['BuildCorp Inc.', 'SteelMax Solutions', 'ConcreteWorks LLC', 'EliteBuild Co.', 'MegaConstruct'];
                this.projectNames = [
                    'Downtown Office Complex', 'Riverside Shopping Center', 'Metro Bridge Extension', 
                    'Hospital Wing Addition', 'Residential Tower Alpha', 'Industrial Warehouse B',
                    'School Renovation Project', 'Highway Overpass', 'Community Center', 'Parking Garage'
                ];
                this.resourceTypes = ['Engineers', 'Construction Workers', 'Project Managers', 'Equipment', 'Materials'];
            }

            generateCostData(numProjects = 10) {
                const data = [];
                for (let i = 1; i <= numProjects; i++) {
                    const plannedCost = Math.floor(Math.random() * 900000) + 100000; // $100K - $1M
                    const variance = (Math.random() - 0.5) * 0.4; // ¬±20% variance
                    const actualCost = plannedCost * (1 + variance);
                    
                    data.push({
                        projectId: `PRJ-${i.toString().padStart(3, '0')}`,
                        projectName: this.projectNames[i - 1] || `Project ${i}`,
                        plannedCost: plannedCost,
                        actualCost: Math.floor(actualCost),
                        vendorName: this.vendors[Math.floor(Math.random() * this.vendors.length)],
                        costVariance: Math.floor(actualCost - plannedCost)
                    });
                }
                return data;
            }

            generateScheduleData(projectIds) {
                return projectIds.map(id => {
                    const plannedDuration = Math.floor(Math.random() * 300) + 30; // 30-330 days
                    const variance = (Math.random() - 0.3) * 0.5; // Slight bias towards delays
                    const actualDuration = Math.floor(plannedDuration * (1 + variance));
                    
                    return {
                        projectId: id,
                        plannedDuration: plannedDuration,
                        actualDuration: actualDuration,
                        scheduleVariance: actualDuration - plannedDuration,
                        milestones: Math.floor(Math.random() * 8) + 3
                    };
                });
            }

            generateResourceData(projectIds) {
                const data = [];
                projectIds.forEach(id => {
                    this.resourceTypes.forEach(resourceType => {
                        const allocated = Math.floor(Math.random() * 1000) + 100;
                        const utilizationRate = 0.6 + Math.random() * 0.4; // 60-100% utilization
                        const used = Math.floor(allocated * utilizationRate);
                        
                        data.push({
                            projectId: id,
                            resourceType: resourceType,
                            hoursAllocated: allocated,
                            hoursUsed: used,
                            utilization: (used / allocated * 100).toFixed(1)
                        });
                    });
                });
                return data;
            }
        }

        // Dashboard Controller
        class ConstructionDashboard {
            constructor() {
                this.dataGenerator = new DataGenerator();
                this.costData = [];
                this.scheduleData = [];
                this.resourceData = [];
                this.charts = {};
                this.initializeData();
                this.setupEventListeners();
                this.renderDashboard();
            }

            initializeData() {
                console.log('Initializing data...');
                this.costData = this.dataGenerator.generateCostData(10);
                const projectIds = this.costData.map(d => d.projectId);
                this.scheduleData = this.dataGenerator.generateScheduleData(projectIds);
                this.resourceData = this.dataGenerator.generateResourceData(projectIds);
                
                // Merge data for comprehensive analysis
                this.mergedData = this.costData.map(cost => {
                    const schedule = this.scheduleData.find(s => s.projectId === cost.projectId);
                    const resources = this.resourceData.filter(r => r.projectId === cost.projectId);
                    const avgUtilization = resources.reduce((acc, r) => acc + parseFloat(r.utilization), 0) / resources.length;
                    
                    return {
                        ...cost,
                        ...schedule,
                        avgUtilization: avgUtilization.toFixed(1),
                        riskLevel: this.calculateRiskLevel(cost.costVariance, schedule.scheduleVariance, avgUtilization)
                    };
                });
                
                console.log('Data initialized:', this.mergedData);
                this.populateFilters();
            }

            calculateRiskLevel(costVar, scheduleVar, utilization) {
                let riskScore = 0;
                if (costVar > 50000) riskScore += 2;
                else if (costVar > 0) riskScore += 1;
                
                if (scheduleVar > 30) riskScore += 2;
                else if (scheduleVar > 0) riskScore += 1;
                
                if (utilization > 95) riskScore += 1;
                else if (utilization > 85) riskScore += 0.5;
                
                if (riskScore >= 3) return 'High';
                if (riskScore >= 1.5) return 'Medium';
                return 'Low';
            }

            populateFilters() {
                const projectFilter = document.getElementById('projectFilter');
                const vendorFilter = document.getElementById('vendorFilter');
                
                // Populate project filter
                this.mergedData.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.projectId;
                    option.textContent = `${project.projectId} - ${project.projectName}`;
                    projectFilter.appendChild(option);
                });
                
                // Populate vendor filter
                const uniqueVendors = [...new Set(this.mergedData.map(p => p.vendorName))];
                uniqueVendors.forEach(vendor => {
                    const option = document.createElement('option');
                    option.value = vendor;
                    option.textContent = vendor;
                    vendorFilter.appendChild(option);
                });
                
                // Set default date
                const dateFilter = document.getElementById('dateFilter');
                dateFilter.value = '2024-09';
            }

            setupEventListeners() {
                document.getElementById('projectFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('vendorFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateFilter').addEventListener('change', () => this.applyFilters());
            }

            applyFilters() {
                // Filter logic would be implemented here
                this.renderDashboard();
            }

            updateKPIs() {
                const totalCostVariance = this.mergedData.reduce((sum, p) => sum + p.costVariance, 0);
                const avgScheduleDelay = this.mergedData.reduce((sum, p) => sum + Math.max(0, p.scheduleVariance), 0) / this.mergedData.length;
                const avgUtilization = this.mergedData.reduce((sum, p) => sum + parseFloat(p.avgUtilization), 0) / this.mergedData.length;
                const projectsAtRisk = this.mergedData.filter(p => p.riskLevel === 'High').length;

                document.getElementById('totalCostVariance').textContent = `$${totalCostVariance.toLocaleString()}`;
                document.getElementById('avgScheduleDelay').textContent = `${Math.round(avgScheduleDelay)} days`;
                document.getElementById('resourceUtilization').textContent = `${avgUtilization.toFixed(1)}%`;
                document.getElementById('projectsAtRisk').textContent = projectsAtRisk;

                // Update trend indicators
                document.getElementById('costVarianceTrend').textContent = totalCostVariance > 0 ? '‚Üó Over Budget' : '‚Üò Under Budget';
                document.getElementById('costVarianceTrend').className = `kpi-trend ${totalCostVariance > 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('scheduleDelayTrend').textContent = avgScheduleDelay > 10 ? '‚ö† Delays' : '‚úì On Track';
                document.getElementById('scheduleDelayTrend').className = `kpi-trend ${avgScheduleDelay > 10 ? 'positive' : 'negative'}`;
                
                document.getElementById('utilizationTrend').textContent = avgUtilization > 90 ? '‚ö° High Load' : 'üìä Optimal';
                document.getElementById('utilizationTrend').className = `kpi-trend ${avgUtilization > 90 ? 'positive' : 'negative'}`;
                
                document.getElementById('riskTrend').textContent = projectsAtRisk > 2 ? 'üö® Multiple Risks' : '‚úÖ Managed';
                document.getElementById('riskTrend').className = `kpi-trend ${projectsAtRisk > 2 ? 'positive' : 'negative'}`;
            }

            createVendorChart() {
                const ctx = document.getElementById('vendorChart').getContext('2d');
                const vendorData = {};
                
                this.mergedData.forEach(project => {
                    if (!vendorData[project.vendorName]) {
                        vendorData[project.vendorName] = { planned: 0, actual: 0, count: 0 };
                    }
                    vendorData[project.vendorName].planned += project.plannedCost;
                    vendorData[project.vendorName].actual += project.actualCost;
                    vendorData[project.vendorName].count++;
                });

                const labels = Object.keys(vendorData);
                const overruns = labels.map(vendor => 
                    ((vendorData[vendor].actual - vendorData[vendor].planned) / vendorData[vendor].planned * 100).toFixed(1)
                );

                this.charts.vendorChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cost Overrun %',
                            data: overruns,
                            backgroundColor: overruns.map(val => val > 0 ? 'rgba(231, 76, 60, 0.8)' : 'rgba(39, 174, 96, 0.8)'),
                            borderColor: overruns.map(val => val > 0 ? 'rgba(231, 76, 60, 1)' : 'rgba(39, 174, 96, 1)'),
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    afterLabel: (context) => {
                                        const vendor = context.label;
                                        const data = vendorData[vendor];
                                        return [
                                            `Projects: ${data.count}`,
                                            `Total Planned: $${data.planned.toLocaleString()}`,
                                            `Total Actual: $${data.actual.toLocaleString()}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Cost Overrun (%)' }
                            }
                        }
                    }
                });
            }

            createCostTrendChart() {
                const ctx = document.getElementById('costTrendChart').getContext('2d');
                const sortedProjects = [...this.mergedData].sort((a, b) => a.projectId.localeCompare(b.projectId));

                this.charts.costTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedProjects.map(p => p.projectId),
                        datasets: [
                            {
                                label: 'Planned Cost',
                                data: sortedProjects.map(p => p.plannedCost),
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Actual Cost',
                                data: sortedProjects.map(p => p.actualCost),
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    afterLabel: (context) => {
                                        const project = sortedProjects[context.dataIndex];
                                        return [
                                            `Project: ${project.projectName}`,
                                            `Variance: $${project.costVariance.toLocaleString()}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Cost ($)' },
                                ticks: {
                                    callback: (value) => `$${(value/1000).toFixed(0)}K`
                                }
                            },
                            x: { title: { display: true, text: 'Projects' } }
                        }
                    }
                });
            }

            createResourceChart() {
                const ctx = document.getElementById('resourceChart').getContext('2d');
                
                this.charts.resourceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: this.mergedData.map(p => p.projectId),
                        datasets: [{
                            data: this.mergedData.map(p => parseFloat(p.avgUtilization)),
                            backgroundColor: this.mergedData.map(p => {
                                const util = parseFloat(p.avgUtilization);
                                if (util > 95) return 'rgba(231, 76, 60, 0.8)';
                                if (util > 85) return 'rgba(243, 156, 18, 0.8)';
                                return 'rgba(39, 174, 96, 0.8)';
                            }),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'right',
                                labels: { 
                                    generateLabels: (chart) => {
                                        return chart.data.labels.map((label, index) => ({
                                            text: `${label} (${chart.data.datasets[0].data[index]}%)`,
                                            fillStyle: chart.data.datasets[0].backgroundColor[index]
                                        }));
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const project = this.mergedData[context.dataIndex];
                                        return [
                                            `${project.projectName}`,
                                            `Utilization: ${context.parsed}%`,
                                            `Risk Level: ${project.riskLevel}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createScheduleChart() {
                const ctx = document.getElementById('scheduleChart').getContext('2d');
                const scheduleCategories = {
                    'Ahead of Schedule': this.mergedData.filter(p => p.scheduleVariance < -5).length,
                    'On Schedule': this.mergedData.filter(p => p.scheduleVariance >= -5 && p.scheduleVariance <= 5).length,
                    'Minor Delay': this.mergedData.filter(p => p.scheduleVariance > 5 && p.scheduleVariance <= 30).length,
                    'Major Delay': this.mergedData.filter(p => p.scheduleVariance > 30).length
                };

                this.charts.scheduleChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(scheduleCategories),
                        datasets: [{
                            data: Object.values(scheduleCategories),
                            backgroundColor: [
                                'rgba(39, 174, 96, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(243, 156, 18, 0.8)',
                                'rgba(231, 76, 60, 0.8)'
                            ],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} projects (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateProjectTable() {
                const tbody = document.getElementById('projectTableBody');
                tbody.innerHTML = '';

                this.mergedData.forEach(project => {
                    const row = document.createElement('tr');
                    
                    const getStatusClass = (variance, type) => {
                        if (type === 'cost') {
                            if (variance > 50000) return 'status-overbudget';
                            if (variance > 0) return 'status-warning';
                            return 'status-ontrack';
                        } else if (type === 'schedule') {
                            if (project.scheduleVariance > 30) return 'status-overbudget';
                            if (project.scheduleVariance > 0) return 'status-warning';
                            return 'status-ontrack';
                        }
                    };

                    const getScheduleStatus = (variance) => {
                        if (variance > 30) return 'Major Delay';
                        if (variance > 5) return 'Minor Delay';
                        if (variance >= -5) return 'On Track';
                        return 'Ahead';
                    };

                    row.innerHTML = `
                        <td><strong>${project.projectId}</strong></td>
                        <td>${project.projectName}</td>
                        <td>${project.vendorName}</td>
                        <td>${project.plannedCost.toLocaleString()}</td>
                        <td>${project.actualCost.toLocaleString()}</td>
                        <td class="${getStatusClass(project.costVariance, 'cost')}">
                            ${project.costVariance > 0 ? '+' : ''}${project.costVariance.toLocaleString()}
                        </td>
                        <td class="status-cell ${getStatusClass(project.scheduleVariance, 'schedule')}">
                            ${getScheduleStatus(project.scheduleVariance)}
                        </td>
                        <td>${project.avgUtilization}%</td>
                        <td class="status-cell ${project.riskLevel === 'High' ? 'status-overbudget' : project.riskLevel === 'Medium' ? 'status-warning' : 'status-ontrack'}">
                            ${project.riskLevel}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            generateInsights() {
                const insights = [];
                
                // Cost Analysis Insights
                const highCostVarianceProjects = this.mergedData.filter(p => p.costVariance > 100000);
                if (highCostVarianceProjects.length > 0) {
                    insights.push({
                        type: 'critical',
                        title: 'üö® Critical Cost Overruns Detected',
                        description: `${highCostVarianceProjects.length} projects have cost overruns exceeding $100K. Top offender: ${highCostVarianceProjects[0].projectName} with ${((highCostVarianceProjects[0].costVariance / highCostVarianceProjects[0].plannedCost) * 100).toFixed(1)}% overrun.`,
                        recommendation: 'Immediate review of vendor contracts and scope changes required.'
                    });
                }

                // Vendor Performance Insights
                const vendorPerformance = {};
                this.mergedData.forEach(p => {
                    if (!vendorPerformance[p.vendorName]) {
                        vendorPerformance[p.vendorName] = { projects: 0, totalVariance: 0 };
                    }
                    vendorPerformance[p.vendorName].projects++;
                    vendorPerformance[p.vendorName].totalVariance += p.costVariance;
                });

                const worstVendor = Object.keys(vendorPerformance).reduce((worst, vendor) => {
                    const avgVariance = vendorPerformance[vendor].totalVariance / vendorPerformance[vendor].projects;
                    const worstAvg = vendorPerformance[worst].totalVariance / vendorPerformance[worst].projects;
                    return avgVariance > worstAvg ? vendor : worst;
                });

                if (vendorPerformance[worstVendor].totalVariance > 50000) {
                    insights.push({
                        type: 'warning',
                        title: '‚ö†Ô∏è Vendor Performance Alert',
                        description: `${worstVendor} shows consistent cost overruns with average variance of ${(vendorPerformance[worstVendor].totalVariance / vendorPerformance[worstVendor].projects).toLocaleString()} per project.`,
                        recommendation: 'Consider renegotiating contracts or evaluating alternative vendors.'
                    });
                }

                // Resource Utilization Insights
                const highUtilizationProjects = this.mergedData.filter(p => parseFloat(p.avgUtilization) > 95);
                if (highUtilizationProjects.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: '‚ö° Resource Burnout Risk',
                        description: `${highUtilizationProjects.length} projects showing >95% resource utilization. Risk of burnout and quality issues.`,
                        recommendation: 'Consider resource reallocation or timeline adjustments to prevent team burnout.'
                    });
                }

                // Schedule Performance Insights
                const schedulePerfProjects = this.mergedData.filter(p => p.scheduleVariance < -10);
                if (schedulePerfProjects.length > 0) {
                    insights.push({
                        type: 'success',
                        title: '‚úÖ Schedule Optimization Opportunities',
                        description: `${schedulePerfProjects.length} projects completed ahead of schedule. Average time saved: ${Math.abs(schedulePerfProjects.reduce((sum, p) => sum + p.scheduleVariance, 0) / schedulePerfProjects.length).toFixed(0)} days.`,
                        recommendation: 'Analyze best practices from these projects to improve overall delivery times.'
                    });
                }

                // Risk Assessment Insights
                const highRiskProjects = this.mergedData.filter(p => p.riskLevel === 'High');
                if (highRiskProjects.length > 0) {
                    insights.push({
                        type: 'critical',
                        title: 'üéØ High-Risk Projects Require Attention',
                        description: `${highRiskProjects.length} projects classified as high-risk due to combined cost, schedule, and resource factors.`,
                        recommendation: 'Implement enhanced monitoring and consider project restructuring or additional resources.'
                    });
                }

                // Cost Efficiency Insights
                const efficientProjects = this.mergedData.filter(p => p.costVariance < -20000);
                if (efficientProjects.length > 0) {
                    const totalSavings = Math.abs(efficientProjects.reduce((sum, p) => sum + p.costVariance, 0));
                    insights.push({
                        type: 'success',
                        title: 'üí∞ Cost Savings Achievement',
                        description: `${efficientProjects.length} projects delivered under budget, achieving total savings of ${totalSavings.toLocaleString()}.`,
                        recommendation: 'Document and replicate successful cost management strategies across other projects.'
                    });
                }

                return insights;
            }

            updateInsights() {
                const container = document.getElementById('insightsContainer');
                const insights = this.generateInsights();
                
                if (insights.length === 0) {
                    container.innerHTML = '<div class="insight-item insight-success">üéâ All projects are performing within acceptable parameters!</div>';
                    return;
                }

                container.innerHTML = insights.map(insight => `
                    <div class="insight-item insight-${insight.type}">
                        <h4>${insight.title}</h4>
                        <p><strong>Analysis:</strong> ${insight.description}</p>
                        <p><strong>Recommendation:</strong> ${insight.recommendation}</p>
                    </div>
                `).join('');
            }

            renderDashboard() {
                console.log('Rendering dashboard...');
                
                // Update KPIs
                this.updateKPIs();
                
                // Create charts
                this.createVendorChart();
                this.createCostTrendChart();
                this.createResourceChart();
                this.createScheduleChart();
                
                // Update table
                this.updateProjectTable();
                
                // Update insights
                this.updateInsights();
                
                console.log('Dashboard rendered successfully!');
            }

            // Method to simulate real-time updates
            simulateRealTimeUpdates() {
                setInterval(() => {
                    // Randomly update some values to simulate real-time data
                    const randomProject = this.mergedData[Math.floor(Math.random() * this.mergedData.length)];
                    const randomChange = (Math.random() - 0.5) * 10000;
                    randomProject.actualCost += randomChange;
                    randomProject.costVariance = randomProject.actualCost - randomProject.plannedCost;
                    
                    // Update only KPIs for performance
                    this.updateKPIs();
                }, 30000); // Update every 30 seconds
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dashboard...');
            const dashboard = new ConstructionDashboard();
            
            // Start real-time simulation
            dashboard.simulateRealTimeUpdates();
            
            // Add export functionality
            window.exportData = function(format) {
                if (format === 'csv') {
                    const csv = dashboard.mergedData.map(row => 
                        Object.values(row).join(',')
                    ).join('\n');
                    
                    const header = Object.keys(dashboard.mergedData[0]).join(',');
                    const fullCsv = header + '\n' + csv;
                    
                    const blob = new Blob([fullCsv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'construction_analysis.csv';
                    a.click();
                }
            };
            
            console.log('Dashboard initialization complete!');
        });

        // Add some additional utility functions
        function refreshDashboard() {
            location.reload();
        }

        function toggleFullscreen(elementId) {
            const element = document.getElementById(elementId);
            if (element.requestFullscreen) {
                element.requestFullscreen();
            }
        }
    </script>
</body>
</html>
